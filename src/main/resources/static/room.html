<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>🎙 Voice Room</title>
    <style>
        body { font-family:"Inter",sans-serif;margin:0;padding:2em;background:linear-gradient(145deg,#f0f0f0,#dcdcdc);color:#111;transition:background 0.4s,color 0.4s; }
        body.dark { background: linear-gradient(145deg,#1c1c1c,#2a2a2a); color:#eee; }
        .container { max-width:640px;margin:0 auto;background:rgba(255,255,255,0.85);backdrop-filter:blur(8px);border-radius:16px;padding:2em;box-shadow:0 6px 20px rgba(0,0,0,0.1);transition:background 0.4s; }
        body.dark .container { background: rgba(40,40,40,0.85); }
        h1 { text-align:center;margin-bottom:1em; }
        #status { text-align:center;margin-bottom:1em;font-weight:600; }
        #status.connected { color:#00c851; }
        #status.disconnected { color:#ff4444; }
        .controls { display:flex;justify-content:center;gap:1em;margin-bottom:1.5em; }
        button { padding:0.7em 1.4em;font-size:1em;border:none;border-radius:8px;background:#007bff;color:#fff;cursor:pointer;transition:all 0.25s; }
        button:hover { background:#0056b3; }
        button.leave { background:#dc3545; }
        button.leave:hover { background:#b02a37; }
        button.muted { background:#6c757d; }
        button.muted:hover { background:#5a6268; }
        #users { background: rgba(255,255,255,0.6); border-radius:12px; padding:1em; box-shadow:inset 0 0 8px rgba(0,0,0,0.05); transition: background 0.4s; }
        body.dark #users { background: rgba(60,60,60,0.5); }
        .user { padding:0.4em 0.6em; border-radius:8px; margin-bottom:0.3em; }
        .user.active { background: rgba(0,123,255,0.1); }
        .user.self { font-weight:bold; }
        .theme-toggle { position: fixed; top:1em; right:1em; cursor:pointer; background:none; border:none; font-size:1.4em; }
    </style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()">🌞</button>
<div class="container">
    <h1>🎧 Voice Room</h1>
    <div id="status" class="disconnected">Connecting...</div>

    <div class="controls">
        <button id="muteBtn">Mute</button>
        <button class="leave" onclick="leaveRoom()">Leave Room</button>
    </div>

    <h2>Participants</h2>
    <div id="users"><p>No users yet...</p></div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const roomId = params.get('id');
    let userName = params.get('name');
    const statusEl = document.getElementById('status');
    const muteBtn = document.getElementById('muteBtn');
    const usersEl = document.getElementById('users');

    let muted = false, ws, audioCtx;

    // === Theme handling ===
    function toggleTheme() {
      const isDark = document.body.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      document.querySelector(".theme-toggle").textContent = isDark ? "🌙" : "🌞";
    }
    (function restoreTheme() {
      const theme = localStorage.getItem("theme");
      if(theme==="dark"){document.body.classList.add("dark");document.querySelector(".theme-toggle").textContent="🌙";}
    })();

    // === Audio setup ===
    async function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const input = audioCtx.createMediaStreamSource(stream);
      const processor = audioCtx.createScriptProcessor(4096,1,1);
      input.connect(processor);
      processor.connect(audioCtx.destination);

      processor.onaudioprocess = e=>{
        if(muted||!ws||ws.readyState!==WebSocket.OPEN) return;
        const data = e.inputBuffer.getChannelData(0);
        const int16 = new Int16Array(data.length);
        for(let i=0;i<data.length;i++) int16[i]=data[i]*0x7fff;
        ws.send(int16.buffer);
      };
    }

    // === Users rendering ===
    function renderUsers(list){
      usersEl.innerHTML="";
      if(!list.length){usersEl.innerHTML="<p>No users yet...</p>"; return;}
      list.forEach(u=>{
        const div=document.createElement("div");
        div.className="user"+(u===userName?" self":"")+(u.active?" active":"");
        div.textContent=u.name||u;
        usersEl.appendChild(div);
      });
    }

    // === WebSocket ===
    async function connect(){
      if(!userName){
        userName = prompt("Enter your name");
        if(!userName){ window.location.href="/"; return; }
      }

      const wsProtocol = window.location.protocol==="https:"?"wss:":"ws:";
      const wsUrl=`${wsProtocol}//192.168.0.112:8443/voice?room=${roomId}&name=${encodeURIComponent(userName)}`;
      ws = new WebSocket(wsUrl);
      ws.binaryType="arraybuffer";

      ws.onopen=()=>{
        statusEl.textContent="Connected ✅";
        statusEl.className="connected";
        initAudio();
      };

      ws.onmessage=event=>{
        if(typeof event.data==="string"){
          try{
            const data = JSON.parse(event.data);
            if(data.users) renderUsers(data.users);
            if(data.kick && data.kick.includes(userName)){
              alert("You were disconnected!");
              window.location.href="/";
            }
          }catch(_){}
          return;
        }
        const data = new Int16Array(event.data);
        const buffer = audioCtx.createBuffer(1,data.length,44100);
        const float32 = buffer.getChannelData(0);
        for(let i=0;i<data.length;i++) float32[i]=data[i]/0x7fff;
        const src = audioCtx.createBufferSource(); src.buffer=buffer; src.connect(audioCtx.destination); src.start();
      };

      ws.onclose=()=>{
        statusEl.textContent="Disconnected ❌";
        statusEl.className="disconnected";
        setTimeout(()=>window.location.href="/",1500);
      };
    }

    muteBtn.onclick=()=>{ muted=!muted; muteBtn.textContent=muted?"Unmute":"Mute"; muteBtn.classList.toggle("muted",muted); };
    function leaveRoom(){ if(ws&&ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({leave:true})); ws.close(); }

    connect();
</script>
</body>
</html>
