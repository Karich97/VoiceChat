<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üéô Voice Chat Rooms</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        :root {
          --bg: #f0f0f3;
          --fg: #111;
          --card: #fff;
          --btn: #007bff;
          --btn-hover: #0056b3;
          --shadow-light: rgba(255, 255, 255, 0.7);
          --shadow-dark: rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
          --bg: #121212;
          --fg: #eee;
          --card: #1e1e1e;
          --btn: #1a73e8;
          --btn-hover: #2c8dff;
          --shadow-light: rgba(255, 255, 255, 0.05);
          --shadow-dark: rgba(0, 0, 0, 0.8);
        }

        body {
          font-family: "Inter", sans-serif;
          background: var(--bg);
          color: var(--fg);
          margin: 0;
          padding: 2em;
          transition: background 0.3s, color 0.3s;
        }

        h1 {
          text-align: center;
          font-size: 1.8em;
          margin-bottom: 1.5em;
        }

        .container {
          max-width: 640px;
          margin: 0 auto;
          background: var(--card);
          border-radius: 16px;
          padding: 2em;
          box-shadow:
            8px 8px 20px var(--shadow-dark),
            -8px -8px 20px var(--shadow-light);
          transition: all 0.3s;
        }

        .theme-toggle {
          position: absolute;
          top: 1em;
          right: 1em;
          cursor: pointer;
          font-size: 1.4em;
          background: none;
          border: none;
          color: var(--fg);
          transition: transform 0.2s;
        }
        .theme-toggle:hover { transform: scale(1.2); }

        .qr-section {
          text-align: center;
          margin-bottom: 2em;
        }

        .qr-section canvas {
          margin-top: 0.5em;
          border-radius: 10px;
          background: #fff;
          padding: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .create-room {
          display: flex;
          gap: 0.6em;
          margin-bottom: 1.5em;
        }

        input {
          flex: 1;
          padding: 0.6em;
          font-size: 1em;
          border-radius: 10px;
          border: none;
          box-shadow:
            inset 4px 4px 8px var(--shadow-dark),
            inset -4px -4px 8px var(--shadow-light);
          background: var(--card);
          color: var(--fg);
          outline: none;
        }

        button {
          padding: 0.6em 1.2em;
          font-size: 1em;
          border: none;
          border-radius: 10px;
          background: var(--btn);
          color: white;
          cursor: pointer;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
          transition: all 0.25s;
        }

        button:hover { background: var(--btn-hover); }

        h2 {
          margin-top: 2em;
          font-size: 1.2em;
        }

        ul { list-style: none; padding: 0; }

        .room {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: var(--card);
          padding: 1em;
          border-radius: 12px;
          margin-bottom: 0.8em;
          box-shadow:
            4px 4px 10px var(--shadow-dark),
            -4px -4px 10px var(--shadow-light);
        }

        /* QR Modal */
        #qrModal {
          display: none;
          position: fixed;
          z-index: 999;
          left: 0; top: 0;
          width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.7);
          justify-content: center;
          align-items: center;
        }

        #qrContent {
          background: var(--card);
          padding: 2em;
          border-radius: 16px;
          text-align: center;
          box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        #qrcode canvas {
          display: block;
          margin: 0 auto;
          border-radius: 10px;
          background: #fff;
        }

        #closeQr {
          background: var(--btn);
          margin-top: 1em;
        }
    </style>
</head>
<body>
<button class="theme-toggle" id="themeBtn">üåô</button>

<div class="container">
    <h1>üéß Voice Chat Rooms</h1>

    <div class="qr-section">
        <p>üì± Open this on your phone:</p>
        <canvas id="mainQR"></canvas>
    </div>

    <div class="create-room">
        <input id="roomName" type="text" placeholder="Enter your name" />
        <button onclick="createRoom()">Create Room</button>
    </div>

    <h2>Available Rooms</h2>
    <ul id="roomList"></ul>
</div>

<!-- QR Modal -->
<div id="qrModal">
    <div id="qrContent">
        <div id="qrcode"></div>
        <button id="closeQr">Close</button>
    </div>
</div>

<script>
    const apiUrl = "/rooms";
    const LOCAL_IP = "192.168.0.112";
    const PORT = 8443;

    // === Theme handling ===
    const themeBtn = document.getElementById("themeBtn");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    const savedTheme = localStorage.getItem("theme") || (prefersDark ? "dark" : "light");
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeBtn.textContent = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

    themeBtn.onclick = () => {
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
      themeBtn.textContent = next === "dark" ? "‚òÄÔ∏è" : "üåô";
      updateMainQR();
    };

    // === Main QR ===
    function updateMainQR() {
      const mainUrl = `https://${LOCAL_IP}:${PORT}/`;
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      QRCode.toCanvas(document.getElementById("mainQR"), mainUrl, {
        color: {
          dark: isDark ? "#ffffff" : "#000000",
          light: isDark ? "#111111" : "#ffffff"
        },
        width: 180
      });
    }

    updateMainQR();

    async function fetchRooms() {
      const res = await fetch(apiUrl);
      const rooms = await res.json();
      const list = document.getElementById("roomList");
      list.innerHTML = "";

      if (rooms.length === 0) {
        list.innerHTML = "<li>No active rooms yet.</li>";
        return;
      }

      rooms.forEach(room => {
        const li = document.createElement("li");
        li.className = "room";
        li.innerHTML = `
          <span>${room.name}</span>
          <div>
            <button onclick="joinRoom('${room.id}')">Join</button>
            <button onclick="showQr('${room.id}')">üì± QR</button>
          </div>
        `;
        list.appendChild(li);
      });
    }

    async function createRoom() {
      const name = document.getElementById("roomName").value.trim();
      if (!name) return alert("Please enter your name");

      const res = await fetch(`${apiUrl}?name=${encodeURIComponent(name)}`, { method: "POST" });
      if (res.ok) {
        const room = await res.json();
        window.location.href = `room.html?id=${encodeURIComponent(room.id)}&name=${encodeURIComponent(name)}`;
      } else {
        alert("Failed to create room");
      }
    }

    function joinRoom(id) {
      const userName = prompt("Enter your name:");
      if (!userName) return;
      window.location.href = `room.html?id=${encodeURIComponent(id)}&name=${encodeURIComponent(userName)}`;
    }

    // === QR modal ===
    function showQr(roomId) {
      const qrModal = document.getElementById("qrModal");
      const qrDiv = document.getElementById("qrcode");
      qrDiv.innerHTML = "";

      const userName = "guest";
      const url = `https://${LOCAL_IP}:${PORT}/room.html?id=${roomId}&name=${encodeURIComponent(userName)}`;
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";

      QRCode.toCanvas(qrDiv, url, {
        color: {
          dark: isDark ? "#ffffff" : "#000000",
          light: isDark ? "#111111" : "#ffffff"
        },
        width: 240
      });

      qrModal.style.display = "flex";
    }

    document.getElementById("closeQr").onclick = () => {
      document.getElementById("qrModal").style.display = "none";
    };

    window.onclick = e => {
      const modal = document.getElementById("qrModal");
      if (e.target === modal) modal.style.display = "none";
    };

    fetchRooms();
    setInterval(fetchRooms, 3000);
</script>
</body>
</html>
